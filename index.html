<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GabonJob - Emplois de vacances au Gabon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gabonGreen: '#009E60',
                        gabonYellow: '#FCD116',
                        gabonBlue: '#3A75C4',
                    }
                }
            }
        }
    </script>
    <style>
        .blur-content { filter: blur(4px); user-select: none; pointer-events: none; }
        .premium-badge { background: linear-gradient(45deg, #FCD116, #FFD700); color: #000; font-weight: bold; }
        .loader { border-top-color: #009E60; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <nav class="bg-white shadow-md fixed w-full z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2 cursor-pointer" onclick="app.navigate('home')">
                <div class="h-8 w-8 bg-gabonGreen rounded-full flex items-center justify-center text-white font-bold">G</div>
                <span class="text-xl font-bold text-gabonBlue">Gabon<span class="text-gabonGreen">Job</span></span>
            </div>
            
            <div id="nav-links" class="hidden md:flex space-x-6 items-center">
                </div>

            <button class="md:hidden text-gray-600 focus:outline-none">
                <i class="fas fa-bars fa-lg"></i>
            </button>
        </div>
    </nav>

    <div id="app-container" class="pt-20 min-h-screen flex flex-col">
        
        <section id="page-home" class="page flex-grow">
            <div class="bg-gradient-to-r from-gabonGreen to-gabonBlue text-white py-20">
                <div class="container mx-auto px-4 text-center">
                    <h1 class="text-4xl md:text-5xl font-bold mb-4">Trouvez votre Job de Vacances au Gabon</h1>
                    <p class="text-xl mb-8">La premi√®re plateforme reliant √©tudiants et employeurs dans les 9 provinces.</p>
                    
                    <div class="bg-white p-4 rounded-lg shadow-lg max-w-3xl mx-auto flex flex-col md:flex-row gap-4">
                        <input type="text" id="search-keyword" placeholder="Mots-cl√©s (ex: Serveur, Vendeur)" class="flex-grow p-3 border rounded text-gray-700">
                        <select id="search-province" class="p-3 border rounded text-gray-700">
                            <option value="">Toutes les provinces</option>
                            <option value="Estuaire">Estuaire (Libreville)</option>
                            <option value="Ogoou√©-Maritime">Ogoou√©-Maritime (Port-Gentil)</option>
                            <option value="Haut-Ogoou√©">Haut-Ogoou√© (Franceville)</option>
                            <option value="Woleu-Ntem">Woleu-Ntem (Oyem)</option>
                            <option value="Ngouni√©">Ngouni√© (Mouila)</option>
                            <option value="Nyanga">Nyanga (Tchibanga)</option>
                            <option value="Ogoou√©-Ivindo">Ogoou√©-Ivindo (Makokou)</option>
                            <option value="Ogoou√©-Lolo">Ogoou√©-Lolo (Koulamoutou)</option>
                            <option value="Moyen-Ogoou√©">Moyen-Ogoou√© (Lambar√©n√©)</option>
                        </select>
                        <button onclick="app.searchJobs()" class="bg-gabonYellow text-gray-900 font-bold py-3 px-6 rounded hover:bg-yellow-400">Rechercher</button>
                    </div>
                </div>
            </div>

            <div class="container mx-auto px-4 py-12">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center mb-16">
                    <div class="bg-white p-6 rounded shadow">
                        <div class="text-gabonGreen text-4xl font-bold mb-2" id="stat-offers">0</div>
                        <div class="text-gray-600">Offres disponibles</div>
                    </div>
                    <div class="bg-white p-6 rounded shadow">
                        <div class="text-gabonBlue text-4xl font-bold mb-2" id="stat-companies">0</div>
                        <div class="text-gray-600">Entreprises partenaires</div>
                    </div>
                    <div class="bg-white p-6 rounded shadow">
                        <div class="text-gabonYellow text-4xl font-bold mb-2" id="stat-seekers">0</div>
                        <div class="text-gray-600">Candidats inscrits</div>
                    </div>
                </div>

                <h2 class="text-2xl font-bold text-center mb-8">Derni√®res Offres</h2>
                <div id="public-jobs-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
                <div class="text-center mt-8">
                    <button onclick="app.navigate('auth'); app.toggleAuth('register')" class="bg-gabonGreen text-white px-6 py-3 rounded font-bold">Voir toutes les offres</button>
                </div>
            </div>
        </section>

        <section id="page-auth" class="page hidden flex-grow container mx-auto px-4 py-10">
            <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="flex">
                    <button onclick="app.toggleAuth('login')" id="tab-login" class="flex-1 py-4 bg-gray-100 font-bold text-center border-b-2 border-gabonGreen">Connexion</button>
                    <button onclick="app.toggleAuth('register')" id="tab-register" class="flex-1 py-4 bg-gray-50 text-gray-500 font-bold text-center border-b border-gray-200">Inscription</button>
                </div>
                
                <div id="form-login" class="p-6">
                    <h3 class="text-xl font-bold mb-4">Bon retour !</h3>
                    <form onsubmit="app.handleLogin(event)">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                            <input type="email" id="login-email" class="w-full p-2 border rounded" required>
                        </div>
                        <div class="mb-6">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Mot de passe</label>
                            <input type="password" id="login-password" class="w-full p-2 border rounded" required>
                        </div>
                        <button type="submit" class="w-full bg-gabonBlue text-white font-bold py-2 px-4 rounded hover:bg-blue-600">Se connecter</button>
                    </form>
                </div>

                <div id="form-register" class="p-6 hidden">
                    <h3 class="text-xl font-bold mb-4">Cr√©er un compte</h3>
                    <div class="flex gap-4 mb-4">
                        <label class="flex items-center">
                            <input type="radio" name="reg-role" value="seeker" checked class="mr-2"> Chercheur d'emploi
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="reg-role" value="recruiter" class="mr-2"> Recruteur
                        </label>
                    </div>
                    <form onsubmit="app.handleRegister(event)">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <input type="text" id="reg-firstname" placeholder="Pr√©nom" class="p-2 border rounded" required>
                            <input type="text" id="reg-lastname" placeholder="Nom" class="p-2 border rounded" required>
                        </div>
                        <div class="mb-4">
                            <input type="email" id="reg-email" placeholder="Email" class="w-full p-2 border rounded" required>
                        </div>
                        <div class="mb-4">
                            <input type="tel" id="reg-phone" placeholder="T√©l√©phone (ex: 077001122)" class="w-full p-2 border rounded" required>
                            <p class="text-xs text-gray-500 mt-1">Num√©ro Mobile Money pour le paiement.</p>
                        </div>
                        <div class="mb-4">
                            <input type="password" id="reg-password" placeholder="Mot de passe" class="w-full p-2 border rounded" required>
                        </div>
                        
                        <div id="recruiter-fields" class="hidden mb-4 p-3 bg-gray-50 rounded">
                            <input type="text" id="reg-company" placeholder="Nom de l'entreprise" class="w-full p-2 border rounded mb-2">
                            <input type="text" id="reg-whatsapp" placeholder="WhatsApp Recruteur (+241...)" value="+241" class="w-full p-2 border rounded">
                            <p class="text-xs text-gray-500 mt-1">N√©cessaire pour que les candidats postulent.</p>
                        </div>

                        <button type="submit" class="w-full bg-gabonGreen text-white font-bold py-2 px-4 rounded hover:bg-green-600">S'inscrire</button>
                    </form>
                </div>
            </div>
        </section>

        <section id="page-seeker-dashboard" class="page hidden flex-grow container mx-auto px-4 py-8">
            <div class="flex flex-col md:flex-row gap-8">
                <div class="w-full md:w-1/4">
                    <div class="bg-white rounded-lg shadow p-6 mb-6">
                        <div class="text-center mb-4">
                            <div class="w-20 h-20 bg-gray-200 rounded-full mx-auto flex items-center justify-center text-3xl mb-2">üë§</div>
                            <h3 id="seeker-name" class="font-bold text-lg">Nom Utilisateur</h3>
                            <div id="seeker-badge" class="mt-2"></div>
                        </div>
                        <hr class="my-4">
                        <div id="premium-cta" class="text-center">
                            <p class="text-sm text-gray-600 mb-3">D√©bloquez toutes les offres pour seulement 1000 FCFA √† vie !</p>
                            <button onclick="app.initiatePayment()" class="w-full bg-gabonGreen text-white font-bold py-2 rounded shadow animate-pulse">
                                Payer 1000 FCFA <i class="fas fa-lock-open ml-2"></i>
                            </button>
                            <div class="flex justify-center gap-2 mt-3 text-2xl text-gray-400">
                                <i class="fas fa-mobile-alt"></i> <i class="fab fa-cc-visa"></i>
                            </div>
                        </div>
                        <div id="premium-active" class="hidden text-center text-gabonGreen">
                            <i class="fas fa-check-circle fa-3x mb-2"></i>
                            <p class="font-bold">Abonnement Actif</p>
                        </div>
                    </div>
                </div>

                <div class="w-full md:w-3/4">
                    <h2 class="text-2xl font-bold mb-6">Offres d'emploi disponibles</h2>
                    
                    <div class="bg-white p-4 rounded shadow mb-6 flex flex-wrap gap-4">
                        <select id="filter-province" class="border p-2 rounded" onchange="app.renderSeekerJobs()">
                            <option value="">Toutes les provinces</option>
                            <option value="Estuaire">Estuaire</option>
                            </select>
                        <select id="filter-sector" class="border p-2 rounded" onchange="app.renderSeekerJobs()">
                            <option value="">Tous les secteurs</option>
                            <option value="H√¥tellerie">H√¥tellerie</option>
                            <option value="Commerce">Commerce</option>
                            <option value="Informatique">Informatique</option>
                        </select>
                    </div>

                    <div id="seeker-jobs-list" class="space-y-4">
                        </div>
                </div>
            </div>
        </section>

        <section id="page-recruiter-dashboard" class="page hidden flex-grow container mx-auto px-4 py-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Espace Recruteur</h2>
                <button onclick="document.getElementById('modal-post-job').classList.remove('hidden')" class="bg-gabonBlue text-white px-4 py-2 rounded font-bold">
                    <i class="fas fa-plus mr-2"></i> Publier une offre
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-4 rounded shadow border-l-4 border-gabonBlue">
                    <div class="text-3xl font-bold" id="rec-total-jobs">0</div>
                    <div class="text-sm text-gray-500">Offres publi√©es</div>
                </div>
            </div>

            <div class="bg-white rounded shadow overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-4">Titre</th>
                            <th class="p-4">Date</th>
                            <th class="p-4">Vues</th>
                            <th class="p-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recruiter-jobs-table">
                        </tbody>
                </table>
            </div>
        </section>

        <section id="page-admin-dashboard" class="page hidden flex-grow container mx-auto px-4 py-8">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Panneau d'administration</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="bg-white p-6 rounded shadow border-b-4 border-gabonGreen">
                    <div class="text-gray-500 text-sm">Revenus Totaux</div>
                    <div class="text-3xl font-bold text-gabonGreen" id="admin-revenue">0 FCFA</div>
                </div>
                <div class="bg-white p-6 rounded shadow border-b-4 border-blue-500">
                    <div class="text-gray-500 text-sm">Utilisateurs</div>
                    <div class="text-3xl font-bold" id="admin-users-count">0</div>
                </div>
                <div class="bg-white p-6 rounded shadow border-b-4 border-yellow-400">
                    <div class="text-gray-500 text-sm">Abonn√©s Payants</div>
                    <div class="text-3xl font-bold" id="admin-paid-count">0</div>
                </div>
                <div class="bg-white p-6 rounded shadow border-b-4 border-gray-500">
                    <div class="text-gray-500 text-sm">Offres Actives</div>
                    <div class="text-3xl font-bold" id="admin-jobs-count">0</div>
                </div>
            </div>

            <div class="mb-6 border-b">
                <button onclick="app.switchAdminTab('users')" class="px-4 py-2 border-b-2 border-gabonGreen font-bold">Utilisateurs</button>
                <button onclick="app.switchAdminTab('transactions')" class="px-4 py-2 text-gray-500">Transactions Maketou</button>
            </div>

            <div id="admin-tab-users" class="bg-white rounded shadow overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th class="px-6 py-3">Nom</th>
                            <th class="px-6 py-3">Email</th>
                            <th class="px-6 py-3">R√¥le</th>
                            <th class="px-6 py-3">Statut Paiement</th>
                            <th class="px-6 py-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="admin-users-table">
                        </tbody>
                </table>
            </div>

            <div id="admin-tab-transactions" class="hidden bg-white rounded shadow overflow-x-auto">
                <div class="p-4 flex justify-between items-center">
                    <h3 class="font-bold">Historique Maketou</h3>
                    <button onclick="app.refreshTransactions()" class="text-sm bg-gray-200 px-3 py-1 rounded">Actualiser</button>
                </div>
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th class="px-6 py-3">Cart ID</th>
                            <th class="px-6 py-3">User</th>
                            <th class="px-6 py-3">Montant</th>
                            <th class="px-6 py-3">Statut</th>
                            <th class="px-6 py-3">Date</th>
                        </tr>
                    </thead>
                    <tbody id="admin-transactions-table">
                        </tbody>
                </table>
            </div>
        </section>

        <section id="page-payment-confirmation" class="page hidden flex-grow flex items-center justify-center">
            <div class="bg-white p-8 rounded-lg shadow-lg text-center max-w-md w-full">
                <div id="payment-loading">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto"></div>
                    <h2 class="text-xl font-bold mb-2">V√©rification du paiement...</h2>
                    <p class="text-gray-600">Veuillez patienter, nous interrogeons Maketou.</p>
                </div>
                
                <div id="payment-success" class="hidden">
                    <div class="text-gabonGreen text-5xl mb-4"><i class="fas fa-check-circle"></i></div>
                    <h2 class="text-2xl font-bold mb-2">Paiement R√©ussi !</h2>
                    <p class="text-gray-600 mb-6">F√©licitations, vous √™tes maintenant membre Premium √† vie.</p>
                    <button onclick="window.location.href = window.location.origin" class="bg-gabonBlue text-white px-6 py-2 rounded font-bold">Acc√©der √† mon espace</button>
                </div>

                <div id="payment-error" class="hidden">
                    <div class="text-red-500 text-5xl mb-4"><i class="fas fa-times-circle"></i></div>
                    <h2 class="text-2xl font-bold mb-2">√âchec du paiement</h2>
                    <p class="text-gray-600 mb-6" id="payment-error-msg">Une erreur est survenue.</p>
                    <button onclick="window.location.href = window.location.origin" class="bg-gray-800 text-white px-6 py-2 rounded font-bold">Retour</button>
                </div>
            </div>
        </section>

    </div>

    <div id="modal-post-job" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Nouvelle Offre</h3>
                <button onclick="document.getElementById('modal-post-job').classList.add('hidden')" class="text-gray-500 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <form onsubmit="app.handlePostJob(event)">
                <div class="mb-3">
                    <label class="block text-sm font-bold mb-1">Titre du poste</label>
                    <input type="text" id="job-title" class="w-full border p-2 rounded" required>
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-bold mb-1">Province</label>
                    <select id="job-province" class="w-full border p-2 rounded" required>
                        <option value="Estuaire">Estuaire</option>
                        <option value="Ogoou√©-Maritime">Ogoou√©-Maritime</option>
                        <option value="Haut-Ogoou√©">Haut-Ogoou√©</option>
                        </select>
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-bold mb-1">Secteur</label>
                    <select id="job-sector" class="w-full border p-2 rounded" required>
                        <option value="Commerce">Commerce & Vente</option>
                        <option value="H√¥tellerie">H√¥tellerie & Restauration</option>
                        <option value="Informatique">Informatique</option>
                        <option value="BTP">Construction & BTP</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-bold mb-1">Salaire (FCFA)</label>
                    <input type="number" id="job-salary" class="w-full border p-2 rounded" required>
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-bold mb-1">Description</label>
                    <textarea id="job-desc" class="w-full border p-2 rounded h-24" required></textarea>
                </div>
                <button type="submit" class="w-full bg-gabonBlue text-white font-bold py-2 rounded">Publier l'offre</button>
            </form>
        </div>
    </div>

    <script>
        // CONFIGURATION MAKETOU
        const MAKETOU_CONFIG = {
            apiKey: 'msk_35395609d94589dfe55e846950480c47fb9f44af58f590faf6ab2bbe0a0c2014',
            baseUrl: 'https://api.maketou.net',
            productDocumentId: '0bdd242d-3ae3-4640-816e-97a5e731796b',
            subscriptionPrice: 1000
        };

        const app = {
            data: {
                users: [],
                jobs: [],
                transactions: [],
                currentUser: null
            },

            init: function() {
                this.loadData();
                this.checkUrlParams(); 
                this.updateUI();
            },

            // --- DATA MANAGEMENT ---
            loadData: function() {
                const storedUsers = localStorage.getItem('gj_users');
                const storedJobs = localStorage.getItem('gj_jobs');
                const storedTrans = localStorage.getItem('gj_transactions');
                const sessionUser = sessionStorage.getItem('gj_current_user');

                if (storedUsers) this.data.users = JSON.parse(storedUsers);
                else this.seedData(); 

                if (storedJobs) this.data.jobs = JSON.parse(storedJobs);
                if (storedTrans) this.data.transactions = JSON.parse(storedTrans);
                if (sessionUser) this.data.currentUser = JSON.parse(sessionUser);
            },

            saveData: function() {
                localStorage.setItem('gj_users', JSON.stringify(this.data.users));
                localStorage.setItem('gj_jobs', JSON.stringify(this.data.jobs));
                localStorage.setItem('gj_transactions', JSON.stringify(this.data.transactions));
                if (this.data.currentUser) {
                    sessionStorage.setItem('gj_current_user', JSON.stringify(this.data.currentUser));
                } else {
                    sessionStorage.removeItem('gj_current_user');
                }
            },

            seedData: function() {
                this.data.users = [
                    { id: 1, firstName: 'Admin', lastName: 'System', email: 'admin@gabonjob.com', password: 'Admin@2025', role: 'admin', phone: '+24100000000', isPremium: true, dateJoined: new Date().toISOString() },
                    { id: 2, firstName: 'Jean', lastName: 'Chercheur', email: 'chercheur@test.com', password: 'Chercheur@123', role: 'seeker', phone: '074001122', isPremium: false, dateJoined: new Date().toISOString() },
                    { id: 3, firstName: 'Paul', lastName: 'Recruteur', email: 'recruteur@test.com', password: 'Recruteur@123', role: 'recruiter', company: 'Gabon Oil', whatsapp: '+241077001122', phone: '077001122', dateJoined: new Date().toISOString() }
                ];
                
                this.data.jobs = [
                    { id: 101, recruiterId: 3, title: 'Serveur Restaurant', company: 'Gabon Oil', province: 'Estuaire', sector: 'H√¥tellerie', salary: 150000, description: 'Recherche serveur dynamique pour juillet-ao√ªt.', whatsapp: '+241077001122', views: 12, date: new Date().toISOString() },
                    { id: 102, recruiterId: 3, title: 'Vendeur Boutique', company: 'Gabon Oil', province: 'Ogoou√©-Maritime', sector: 'Commerce', salary: 120000, description: 'Vente de v√™tements. Exp√©rience souhait√©e.', whatsapp: '+241077001122', views: 5, date: new Date().toISOString() }
                ];
                this.saveData();
            },

            // --- NAVIGATION & UI ---
            navigate: function(pageId) {
                document.querySelectorAll('.page').forEach(el => el.classList.add('hidden'));
                const target = document.getElementById(`page-${pageId}`);
                if (target) target.classList.remove('hidden');
                
                if (pageId === 'home') this.renderHomeStats();
                if (pageId === 'seeker-dashboard') this.renderSeekerJobs();
                if (pageId === 'recruiter-dashboard') this.renderRecruiterJobs();
                if (pageId === 'admin-dashboard') this.renderAdminStats();
                
                window.scrollTo(0,0);
            },

            updateUI: function() {
                const nav = document.getElementById('nav-links');
                if (!this.data.currentUser) {
                    nav.innerHTML = `
                        <a href="#" onclick="app.navigate('home')" class="text-gray-600 hover:text-gabonGreen">Accueil</a>
                        <a href="#" onclick="app.navigate('auth'); app.toggleAuth('login')" class="text-gray-600 hover:text-gabonGreen">Connexion</a>
                        <a href="#" onclick="app.navigate('auth'); app.toggleAuth('register')" class="bg-gabonGreen text-white px-4 py-2 rounded font-bold hover:bg-green-600">S'inscrire</a>
                    `;
                } else {
                    const role = this.data.currentUser.role;
                    let dashboardLink = '';
                    if (role === 'seeker') dashboardLink = `<a href="#" onclick="app.navigate('seeker-dashboard')" class="font-bold text-gabonBlue">Mon Espace</a>`;
                    if (role === 'recruiter') dashboardLink = `<a href="#" onclick="app.navigate('recruiter-dashboard')" class="font-bold text-gabonBlue">Espace Recruteur</a>`;
                    if (role === 'admin') dashboardLink = `<a href="#" onclick="app.navigate('admin-dashboard')" class="font-bold text-red-600">Admin Panel</a>`;

                    nav.innerHTML = `
                        ${dashboardLink}
                        <span class="text-gray-500">Bonjour, ${this.data.currentUser.firstName}</span>
                        <a href="#" onclick="app.logout()" class="text-gray-600 hover:text-red-500"><i class="fas fa-sign-out-alt"></i></a>
                    `;
                }
                this.renderHomeStats();
            },

            // --- AUTHENTICATION ---
            toggleAuth: function(mode) {
                document.getElementById('form-login').classList.toggle('hidden', mode !== 'login');
                document.getElementById('form-register').classList.toggle('hidden', mode !== 'register');
                document.getElementById('tab-login').className = mode === 'login' ? 'flex-1 py-4 bg-gray-100 font-bold text-center border-b-2 border-gabonGreen' : 'flex-1 py-4 bg-gray-50 text-gray-500 font-bold text-center border-b border-gray-200';
                document.getElementById('tab-register').className = mode === 'register' ? 'flex-1 py-4 bg-gray-100 font-bold text-center border-b-2 border-gabonGreen' : 'flex-1 py-4 bg-gray-50 text-gray-500 font-bold text-center border-b border-gray-200';
                
                const radios = document.getElementsByName('reg-role');
                radios.forEach(r => r.addEventListener('change', (e) => {
                    document.getElementById('recruiter-fields').classList.toggle('hidden', e.target.value !== 'recruiter');
                }));
            },

            handleLogin: function(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const pass = document.getElementById('login-password').value;
                
                const user = this.data.users.find(u => u.email === email && u.password === pass);
                
                if (user) {
                    this.data.currentUser = user;
                    this.saveData();
                    this.updateUI();
                    if(user.role === 'seeker') this.navigate('seeker-dashboard');
                    else if(user.role === 'recruiter') this.navigate('recruiter-dashboard');
                    else this.navigate('admin-dashboard');
                } else {
                    alert('Email ou mot de passe incorrect');
                }
            },

            handleRegister: function(e) {
                e.preventDefault();
                const role = document.querySelector('input[name="reg-role"]:checked').value;
                const newUser = {
                    id: Date.now(),
                    firstName: document.getElementById('reg-firstname').value,
                    lastName: document.getElementById('reg-lastname').value,
                    email: document.getElementById('reg-email').value,
                    phone: document.getElementById('reg-phone').value,
                    password: document.getElementById('reg-password').value,
                    role: role,
                    dateJoined: new Date().toISOString()
                };

                if (role === 'seeker') {
                    newUser.isPremium = false;
                } else if (role === 'recruiter') {
                    newUser.company = document.getElementById('reg-company').value;
                    newUser.whatsapp = document.getElementById('reg-whatsapp').value;
                }

                if (this.data.users.find(u => u.email === newUser.email)) {
                    alert("Cet email est d√©j√† utilis√©.");
                    return;
                }

                this.data.users.push(newUser);
                this.data.currentUser = newUser;
                this.saveData();
                this.updateUI();
                
                if(role === 'seeker') this.navigate('seeker-dashboard');
                else this.navigate('recruiter-dashboard');
            },

            logout: function() {
                this.data.currentUser = null;
                this.saveData();
                window.location.href = window.location.origin + window.location.pathname; 
            },

            // --- JOB SEEKER LOGIC ---
            renderSeekerJobs: function() {
                const list = document.getElementById('seeker-jobs-list');
                const filterProv = document.getElementById('filter-province').value;
                const filterSec = document.getElementById('filter-sector').value;
                const isPremium = this.data.currentUser.isPremium;

                document.getElementById('seeker-name').textContent = `${this.data.currentUser.firstName} ${this.data.currentUser.lastName}`;
                if(isPremium) {
                    document.getElementById('seeker-badge').innerHTML = '<span class="premium-badge px-3 py-1 rounded-full text-xs">PREMIUM ‚úì</span>';
                    document.getElementById('premium-cta').classList.add('hidden');
                    document.getElementById('premium-active').classList.remove('hidden');
                }

                list.innerHTML = '';

                let filtered = this.data.jobs.filter(j => {
                    return (!filterProv || j.province === filterProv) &&
                           (!filterSec || j.sector === filterSec);
                });

                filtered.forEach(job => {
                    let actions = '';
                    let contactInfo = '';

                    if (isPremium) {
                        const encodedText = encodeURIComponent(`Bonjour, je postule pour l'offre ${job.title} vue sur Gabonjob.`);
                        const cleanPhone = job.whatsapp.replace(/\+/g, '').replace(/\s/g, '');
                        
                        actions = `
                            <a href="https://wa.me/${cleanPhone}?text=${encodedText}" target="_blank" 
                               class="bg-green-500 text-white px-4 py-2 rounded font-bold hover:bg-green-600 inline-flex items-center">
                                <i class="fab fa-whatsapp mr-2"></i> Postuler via WhatsApp
                            </a>
                        `;
                        contactInfo = `<p class="text-sm text-gray-600 mt-2"><strong>Contact:</strong> ${job.whatsapp}</p>`;
                    } else {
                        actions = `
                            <button onclick="app.initiatePayment()" class="bg-gray-300 text-gray-600 px-4 py-2 rounded cursor-pointer font-bold border border-gray-400">
                                <i class="fas fa-lock mr-2"></i> Payer pour d√©bloquer
                            </button>
                        `;
                    }

                    const html = `
                        <div class="bg-white p-6 rounded shadow hover:shadow-lg transition">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-xl font-bold text-gabonBlue">${job.title}</h3>
                                    <p class="text-gabonGreen font-bold">${job.company}</p>
                                    <div class="flex gap-2 text-sm text-gray-500 mt-1">
                                        <span><i class="fas fa-map-marker-alt"></i> ${job.province}</span>
                                        <span><i class="fas fa-briefcase"></i> ${job.sector}</span>
                                        <span><i class="fas fa-money-bill"></i> ${job.salary.toLocaleString()} FCFA</span>
                                    </div>
                                </div>
                                <div class="text-xs bg-gray-100 p-1 rounded">${new Date(job.date).toLocaleDateString()}</div>
                            </div>
                            
                            <hr class="my-3">
                            
                            <div class="mb-4">
                                <h4 class="font-bold text-sm mb-1">Description :</h4>
                                <p class="text-gray-700 ${!isPremium ? 'line-clamp-2 blur-content' : ''}">${job.description}</p>
                                ${isPremium ? contactInfo : '<p class="text-red-500 text-sm mt-2 italic"><i class="fas fa-lock"></i> D√©tails complets r√©serv√©s aux membres Premium.</p>'}
                            </div>

                            <div class="flex justify-end">
                                ${actions}
                            </div>
                        </div>
                    `;
                    list.innerHTML += html;
                });
            },

            // --- RECRUITER LOGIC ---
            renderRecruiterJobs: function() {
                const tbody = document.getElementById('recruiter-jobs-table');
                document.getElementById('rec-total-jobs').textContent = this.data.jobs.filter(j => j.recruiterId === this.data.currentUser.id).length;
                tbody.innerHTML = '';

                const myJobs = this.data.jobs.filter(j => j.recruiterId === this.data.currentUser.id);

                myJobs.forEach(job => {
                    tbody.innerHTML += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-4 font-bold">${job.title}</td>
                            <td class="p-4 text-sm text-gray-500">${new Date(job.date).toLocaleDateString()}</td>
                            <td class="p-4">${job.views}</td>
                            <td class="p-4">
                                <button onclick="app.deleteJob(${job.id})" class="text-red-500 hover:underline">Supprimer</button>
                            </td>
                        </tr>
                    `;
                });
            },

            handlePostJob: function(e) {
                e.preventDefault();
                const newJob = {
                    id: Date.now(),
                    recruiterId: this.data.currentUser.id,
                    company: this.data.currentUser.company,
                    whatsapp: this.data.currentUser.whatsapp,
                    title: document.getElementById('job-title').value,
                    province: document.getElementById('job-province').value,
                    sector: document.getElementById('job-sector').value,
                    salary: parseInt(document.getElementById('job-salary').value),
                    description: document.getElementById('job-desc').value,
                    views: 0,
                    date: new Date().toISOString()
                };

                this.data.jobs.unshift(newJob);
                this.saveData();
                document.getElementById('modal-post-job').classList.add('hidden');
                e.target.reset();
                this.renderRecruiterJobs();
                alert('Offre publi√©e avec succ√®s !');
            },

            deleteJob: function(id) {
                if(confirm('Supprimer cette offre ?')) {
                    this.data.jobs = this.data.jobs.filter(j => j.id !== id);
                    this.saveData();
                    this.renderRecruiterJobs();
                }
            },

            // --- ADMIN LOGIC ---
            renderAdminStats: function() {
                const users = this.data.users;
                const paidUsers = users.filter(u => u.isPremium);
                
                document.getElementById('admin-users-count').textContent = users.length;
                document.getElementById('admin-paid-count').textContent = paidUsers.length;
                document.getElementById('admin-revenue').textContent = (paidUsers.length * 1000).toLocaleString() + ' FCFA';
                document.getElementById('admin-jobs-count').textContent = this.data.jobs.length;

                this.switchAdminTab('users'); 
            },

            switchAdminTab: function(tabName) {
                document.getElementById('admin-tab-users').classList.toggle('hidden', tabName !== 'users');
                document.getElementById('admin-tab-transactions').classList.toggle('hidden', tabName !== 'transactions');
                
                if(tabName === 'users') {
                    const tbody = document.getElementById('admin-users-table');
                    tbody.innerHTML = '';
                    this.data.users.forEach(u => {
                        tbody.innerHTML += `
                            <tr class="bg-white border-b hover:bg-gray-50">
                                <td class="px-6 py-4 font-medium text-gray-900">${u.firstName} ${u.lastName}</td>
                                <td class="px-6 py-4">${u.email}</td>
                                <td class="px-6 py-4">${u.role}</td>
                                <td class="px-6 py-4">
                                    ${u.isPremium ? '<span class="text-green-600 font-bold">Pay√©</span>' : '<span class="text-gray-400">Gratuit</span>'}
                                </td>
                                <td class="px-6 py-4">
                                    <button onclick="app.deleteUser(${u.id})" class="text-red-600 hover:underline">Supprimer</button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    this.renderTransactions();
                }
            },

            renderTransactions: function() {
                const tbody = document.getElementById('admin-transactions-table');
                tbody.innerHTML = '';
                this.data.transactions.forEach(t => {
                    tbody.innerHTML += `
                        <tr class="bg-white border-b">
                            <td class="px-6 py-4 font-mono text-xs">${t.cartId}</td>
                            <td class="px-6 py-4">${t.email}</td>
                            <td class="px-6 py-4">1000</td>
                            <td class="px-6 py-4">
                                <span class="${t.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'} text-xs font-medium mr-2 px-2.5 py-0.5 rounded">
                                    ${t.status}
                                </span>
                            </td>
                            <td class="px-6 py-4">${new Date(t.date).toLocaleString()}</td>
                        </tr>
                    `;
                });
            },

            deleteUser: function(id) {
                if(confirm('Supprimer cet utilisateur ?')) {
                    this.data.users = this.data.users.filter(u => u.id !== id);
                    this.saveData();
                    this.switchAdminTab('users');
                }
            },

            // --- MAKETOU PAYMENT INTEGRATION (CORRIG√âE & FINALE) ---
            
            initiatePayment: async function() {
                if (!this.data.currentUser) {
                    alert("Veuillez vous connecter pour vous abonner.");
                    this.navigate('auth');
                    return;
                }

                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traitement...';
                btn.disabled = true;

                try {
                    // --- CORRECTION DU NUM√âRO DE T√âL√âPHONE (IMPOS√â PAR MAKETOU) ---
                    // 1. On garde uniquement les chiffres (0-9)
                    let digits = this.data.currentUser.phone.replace(/\D/g, ''); 
                    
                    // 2. Si le num√©ro commence par un "0" (ex: 077...), on l'enl√®ve
                    if (digits.startsWith('0')) {
                        digits = digits.substring(1);
                    }
                    
                    // 3. Si le num√©ro ne commence pas par "241", on l'ajoute
                    if (!digits.startsWith('241')) {
                        digits = '241' + digits;
                    }

                    // 4. IMPORTANT : On ajoute le "+" au d√©but pour le format international
                    const finalPhone = '+' + digits; 
                    // R√©sultat attendu : +24177001122
                    // ------------------------------------------

                    // Gestion URL (Vercel ou Local)
                    let returnUrl = window.location.href.split('?')[0] + '?page=confirmation';
                    if (!window.location.protocol.startsWith('http')) {
                        alert("‚ö†Ô∏è En local, redirection vers Google apr√®s paiement.");
                        returnUrl = "https://www.google.com"; 
                    }

                    const payload = {
                        productDocumentId: MAKETOU_CONFIG.productDocumentId,
                        email: this.data.currentUser.email,
                        firstName: this.data.currentUser.firstName,
                        lastName: this.data.currentUser.lastName,
                        phone: finalPhone, // On envoie le num√©ro avec le +
                        redirectURL: returnUrl
                    };

                    console.log("Envoi √† Maketou:", payload);

                    const response = await fetch(`${MAKETOU_CONFIG.baseUrl}/api/v1/stores/cart/checkout`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${MAKETOU_CONFIG.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();
                    
                    if (data.redirectUrl) {
                        // SUCC√àS
                        this.data.transactions.push({
                            cartId: data.cartId || 'unknown',
                            email: this.data.currentUser.email,
                            status: 'waiting_payment',
                            date: new Date().toISOString()
                        });
                        this.saveData();
                        window.location.href = data.redirectUrl;
                    } else {
                        // ERREUR
                        console.error("Erreur Maketou:", data);
                        // On affiche un message propre √† l'utilisateur
                        let msg = "Erreur de validation.";
                        if(data.message && Array.isArray(data.message)) {
                            msg = "Erreur sur le champ : " + data.message[0].property;
                        } else if (data.message) {
                            msg = data.message;
                        }
                        alert("Impossible d'initialiser le paiement : " + msg + "\n\n(V√©rifiez que votre num√©ro de t√©l√©phone est correct)");
                        
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }

                } catch (error) {
                    alert("Erreur technique : " + error.message);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            },

            // Handle return from Payment
            checkUrlParams: function() {
                const urlParams = new URLSearchParams(window.location.search);
                const page = urlParams.get('page');
                const cartId = urlParams.get('cartId'); 

                if (page === 'confirmation' && cartId) {
                    this.navigate('payment-confirmation');
                    this.verifyPaymentStatus(cartId);
                }
            },

            verifyPaymentStatus: async function(cartId) {
                try {
                    const response = await fetch(`${MAKETOU_CONFIG.baseUrl}/api/v1/stores/cart/${cartId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${MAKETOU_CONFIG.apiKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();
                    const loading = document.getElementById('payment-loading');
                    const success = document.getElementById('payment-success');
                    const error = document.getElementById('payment-error');

                    loading.classList.add('hidden');

                    if (data.status === 'completed' || data.status === 'success') {
                        // UPDATE USER TO PREMIUM
                        if(this.data.currentUser) {
                            this.data.currentUser.isPremium = true;
                            // Update user in the main list
                            const idx = this.data.users.findIndex(u => u.id === this.data.currentUser.id);
                            if(idx !== -1) this.data.users[idx].isPremium = true;
                            
                            this.saveData();
                        }

                        // Update Transaction log
                        const transIdx = this.data.transactions.findIndex(t => t.cartId === cartId);
                        if(transIdx !== -1) {
                            this.data.transactions[transIdx].status = 'completed';
                            this.saveData();
                        }
                        success.classList.remove('hidden');
                    } else if (data.status === 'payment_failed') {
                        error.classList.remove('hidden');
                        document.getElementById('payment-error-msg').innerText = "Le paiement a √©chou√©.";
                    } else {
                        error.classList.remove('hidden');
                        document.getElementById('payment-error-msg').innerText = "Statut: " + data.status;
                    }

                } catch (err) {
                    document.getElementById('payment-loading').classList.add('hidden');
                    document.getElementById('payment-error').classList.remove('hidden');
                }
            },

            // Helper for Home page
            renderHomeStats: function() {
                document.getElementById('stat-offers').textContent = this.data.jobs.length;
                const uniqueCompanies = [...new Set(this.data.jobs.map(item => item.company))].length;
                document.getElementById('stat-companies').textContent = uniqueCompanies;
                document.getElementById('stat-seekers').textContent = this.data.users.filter(u => u.role === 'seeker').length;
                
                const publicList = document.getElementById('public-jobs-list');
                publicList.innerHTML = '';
                this.data.jobs.slice(0, 3).forEach(job => {
                    publicList.innerHTML += `
                         <div class="bg-white p-6 rounded shadow border-l-4 border-gabonGreen">
                            <h3 class="font-bold text-lg">${job.title}</h3>
                            <p class="text-sm text-gray-500">${job.province}</p>
                            <p class="text-gabonGreen font-bold mt-2">${job.salary} FCFA</p>
                         </div>
                    `;
                });
            },
            
            searchJobs: function() {
                alert("Pour effectuer une recherche avanc√©e, veuillez vous inscrire ou vous connecter.");
                this.navigate('auth');
            }
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
