<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Razerning - Pro Cloud Mining</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

    <style>
        /* Reset & Base */
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #020617; color: white; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        #root { width: 100%; min-height: 100vh; display: flex; flex-direction: column; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-track { background: #0b1120; }
        ::-webkit-scrollbar-thumb { background: #22c55e; border-radius: 2px; }
        
        /* Animations */
        @keyframes pulse-logo { 
            0%, 100% { opacity: 1; transform: scale(1); filter: drop-shadow(0 0 15px rgba(34, 197, 94, 0.5)); } 
            50% { opacity: 0.8; transform: scale(1.05); filter: drop-shadow(0 0 30px rgba(34, 197, 94, 0.8)); } 
        }
        .logo-loading { animation: pulse-logo 2s infinite ease-in-out; }
        
        @keyframes spin-slow { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spin-ring { animation: spin-slow 3s linear infinite; }

        .server-down-banner { animation: flash-red 1.5s infinite; }
        @keyframes flash-red { 0%, 100% { background-color: rgba(220, 38, 38, 1); } 50% { background-color: rgba(153, 27, 27, 1); } }
        
        .live-dot { width: 8px; height: 8px; background-color: #22c55e; border-radius: 50%; position: relative; }
        .live-dot::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #22c55e; border-radius: 50%; animation: pulse-network 2s infinite; }
        @keyframes pulse-network { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }
        
        #initial-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #020617; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s; }
    </style>
</head>
<body>
    
    <div id="initial-loader">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-green-500 mx-auto mb-4"></div>
            <p class="text-slate-400 text-xs font-mono tracking-widest">CHARGEMENT DES MACHINES...</p>
        </div>
    </div>

    <div id="root"></div>

    <div id="global-error" style="display:none; position:fixed; top:0; left:0; right:0; background:red; color:white; padding:20px; z-index:10000; font-size:12px;"></div>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('initial-loader').style.display = 'none';
            document.getElementById('global-error').style.display = 'block';
            document.getElementById('global-error').innerHTML = "<b>ERREUR SYSTÈME :</b> " + message;
        };
    </script>

    <script type="text/babel" data-presets="env,react">
        const { useState, useEffect, useRef } = React;

        // ==========================================================================================
        // --- CONFIGURATION FIREBASE (VOS CLES) ---
        // ==========================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDcRyNwzZEmB85Wl6i2TeDxRFrMZLK4ZcA",
            authDomain: "razermining-f1741.firebaseapp.com",
            projectId: "razermining-f1741",
            storageBucket: "razermining-f1741.firebasestorage.app",
            messagingSenderId: "1037179665926",
            appId: "1:1037179665926:web:c3b4d4a3435938e0d84d87"
        };

        let db;
        try {
            if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
            db = firebase.firestore();
            console.log("✅ Firebase Connecté");
        } catch (e) { console.error("❌ Firebase Erreur:", e); }

        // --- CONSTANTES GLOBALES ---
        const APP_COLLECTION = "razerning_final_prod"; 
        
        // LIENS
        const PAYMENT_BOT_URL = "https://t.me/RazerningBot"; 
        const SUPPORT_CHAT_URL = "https://t.me/RazerningSupport";
        
        const BASE_BTC_PRICE = 67500; 
        const USD_TO_FCFA_RATE = 655;
        const ADMIN_PHONE = "076225865";
        const ADMIN_PASS = "0909";

        // CONFIGURATION PAYS & OPÉRATEURS
        const COUNTRY_CONFIG = {
            "Gabon": ["Airtel Gabon", "Moov Gabon"],
            "Cameroun": ["Ananas Money", "Orange Cameroun", "MTN Cameroun"],
            "Congo": ["Airtel Congo", "MTN Congo"]
        };
        const ALLOWED_COUNTRIES = Object.keys(COUNTRY_CONFIG);

        // PARRAINAGE & FRAIS
        const REFERRAL_MAX_EARNINGS = 5.0; 
        const REFERRAL_STEP = 5; 
        const REWARD_FIRST_STEP = 1.40; 
        const REWARD_NEXT_STEPS = 0.72;
        
        const FEE_VERIFIED = 0.115; 
        const FEE_UNVERIFIED = 0.13; 

        // --- FONCTION GÉNÉRATION ID COURT ---
        const generateShortId = () => {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 7; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        };

        // --- ICONES SVG ---
        const Icon = ({ d, size=20, col="" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={col}><path d={d}/></svg>;
        const IconRect = ({ w, h, x, y, size=20, col="" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={col}><rect width={w} height={h} x={x} y={y} rx="2" ry="2"/><line x1="6" x2="6.01" y1="6" y2="6"/><line x1="6" x2="6.01" y1="18" y2="18"/></svg>;
        
        const Server = (p) => <IconRect w="20" h="8" x="2" y="2" {...p}><rect width="20" height="8" x="2" y="14" rx="2" ry="2"/></IconRect>;
        const Wallet = (p) => <Icon d="M21 12V7H5a2 2 0 0 1 0-4h14v4M3 5v14a2 2 0 0 0 2 2h16v-5M18 12a2 2 0 0 0 0 4h4v-4Z" {...p}/>;
        const Activity = (p) => <Icon d="M22 12h-4l-3 9L9 3l-3 9H2" {...p}/>;
        const User = (p) => <Icon d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" {...p}><circle cx="12" cy="7" r="4"/></Icon>;
        const Zap = (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>;
        const Bitcoin = (p) => <Icon d="M11.767 19.089c4.924.868 6.14-6.302 2.767-8.704 3.373-3.236-.288-8.546-4.962-7.398v-1.74h-2.12v1.853c-.62-.15-1.25-.28-1.873-.404V.856h-2.12v1.86c-.52-.107-1.03-.2-1.52-.28l-.546 2.18s1.52.348 1.487.37c.83.207.98.756.955 1.192v8.527c.03.493-.243 1.195-1.045.993-.036-.022-1.487-.37-1.487-.37l-.988 2.28c.576.145 1.14.305 1.685.47v1.883h2.12v-1.805c.6.166 1.197.316 1.78.46v1.882h2.12v-1.79c3.31.63 6.335.79 6.265.79z" {...p}/>;
        const ArrowRightLeft = (p) => <Icon d="m16 3 4 4-4 4M20 7H4M8 21l-4-4 4-4M4 17h16" {...p}/>;
        const CheckCircle = (p) => <Icon d="M22 11.08V12a10 10 0 1 1-5.93-9.14" {...p}><polyline points="22 4 12 14.01 9 11.01"/></Icon>;
        const AlertCircle = (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconWrapper>;
        const Lock = (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size||20} height={p.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>;
        const Smartphone = (p) => <IconRect w="14" h="20" x="5" y="2" {...p}><line x1="12" y1="18" x2="12.01" y2="18"/></IconRect>;
        const Globe = (p) => <Icon d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" {...p}><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/></Icon>;
        const Headphones = (p) => <Icon d="M3 18v-6a9 9 0 0 1 18 0v6M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z" {...p}/>;
        const LogOut = (p) => <Icon d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9" {...p}/>;
        const Shield = (p) => <Icon d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" {...p}/>;
        const ExternalLink = (p) => <Icon d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" {...p}><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></Icon>;
        const Repeat = (p) => <Icon d="m17 2 4 4-4 4M3 11v-1a4 4 0 0 1 4-4h14M7 22l-4-4 4-4M21 13v1a4 4 0 0 1-4 4H3" {...p}/>;
        const Users = (p) => <Icon d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2M16 3.13a4 4 0 0 1 0 7.75" {...p}><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/></Icon>;
        const Copy = (p) => <IconRect w="14" h="14" x="8" y="8" {...p}><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></IconRect>;
        const WifiOff = (p) => <IconWrapper {...p}><line x1="1" y1="1" x2="23" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></IconWrapper>;
        const Plus = (p) => <IconWrapper {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></IconWrapper>;

        // --- DONNÉES MACHINES ---
        const ALL_MACHINES = [
            { id: 'm1', name: 'WhatsMiner M30S++', power: 112, efficiency: 31, price: 5, durationDays: 30, roiPercent: 200 }, 
            { id: 'm2', name: 'Antminer S19 Pro', power: 110, efficiency: 29.5, price: 15, durationDays: 30, roiPercent: 200 }, 
            { id: 'm3', name: 'AvalonMiner 1246', power: 90, efficiency: 38, price: 30, durationDays: 30, roiPercent: 200 },  
            { id: 'm4', name: 'Antminer S19 XP', power: 140, efficiency: 21.5, price: 50, durationDays: 30, roiPercent: 200 },
            { id: 'm5', name: 'WhatsMiner M50S', power: 126, efficiency: 26, price: 100, durationDays: 30, roiPercent: 200 },
            { id: 'm6', name: 'Antminer S19 XP Hydro', power: 255, efficiency: 20.8, price: 200, durationDays: 30, roiPercent: 200 },
            { id: 'm7', name: 'WhatsMiner M63S', power: 390, efficiency: 18.5, price: 300, durationDays: 30, roiPercent: 200 },
            { id: 'm8', name: 'Bitmain Antminer T21', power: 190, efficiency: 19, price: 400, durationDays: 30, roiPercent: 200 },
            { id: 'm9', name: 'Canaan Avalon A1466', power: 150, efficiency: 21.5, price: 500, durationDays: 30, roiPercent: 200 },
            { id: 'm10', name: 'Rack S19 XP (x5)', power: 700, efficiency: 21.5, price: 1000, durationDays: 30, roiPercent: 200 },
            { id: 'm11', name: 'Industrial Container', power: 2500, efficiency: 22, price: 2500, durationDays: 30, roiPercent: 200 },
            { id: 'y1', name: 'Solo Mining Farm T1', power: 5000, efficiency: 20, price: 1200, durationDays: 365, roiPercent: 3000 },
            { id: 'y2', name: 'Solo Mining Farm T2', power: 8000, efficiency: 19, price: 1500, durationDays: 365, roiPercent: 3000 },
            { id: 'y3', name: 'Hydro Cooling Facility', power: 12000, efficiency: 18, price: 1800, durationDays: 365, roiPercent: 3000 },
            { id: 'y4', name: 'Immersion Cooling Plant', power: 18000, efficiency: 16, price: 2200, durationDays: 365, roiPercent: 3000 },
            { id: 'y5', name: 'Global Hash Center', power: 25000, efficiency: 15, price: 2500, durationDays: 365, roiPercent: 3000 }
        ];

        // --- COMPOSANTS UI ---
        const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false }) => {
            const baseStyle = "px-4 py-3 rounded-lg font-bold transition-all duration-200 flex items-center justify-center gap-2 active:scale-95 touch-manipulation text-sm w-full";
            const variants = {
                primary: "bg-blue-600 text-white shadow-lg hover:bg-blue-500",
                secondary: "bg-slate-800 text-white border border-slate-700 hover:bg-slate-700",
                accent: "bg-amber-500 text-slate-950 hover:bg-amber-400",
                outline: "border border-slate-600 text-slate-300 hover:bg-slate-800",
                danger: "bg-red-500/10 text-red-500 border border-red-500/20 hover:bg-red-500/20"
            };
            return <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${disabled?'opacity-50 cursor-not-allowed':''} ${className}`}>{children}</button>;
        };
        const Card = ({ children, className = '' }) => (<div className={`bg-slate-900/90 backdrop-blur-sm border border-slate-800 rounded-xl p-4 shadow-xl w-full ${className}`}>{children}</div>);
        const Input = ({ type = "text", placeholder, value, onChange, icon: Icon }) => (
            <div className="flex items-center gap-3 bg-slate-950 p-3 rounded-xl border border-slate-800 focus-within:border-blue-500 w-full">
                {Icon && <Icon size={18} className="text-slate-500" />}
                <input type={type} placeholder={placeholder} value={value} onChange={onChange} className="bg-transparent text-white w-full outline-none text-sm font-medium placeholder-slate-600" />
            </div>
        );
        const Select = ({ options, value, onChange, icon: Icon }) => (
            <div className="flex items-center gap-3 bg-slate-950 p-3 rounded-xl border border-slate-800 focus-within:border-blue-500 w-full">
                {Icon && <Icon size={18} className="text-slate-500" />}
                <select value={value} onChange={onChange} className="bg-transparent text-white w-full outline-none text-sm font-medium">
                    <option value="" disabled>Sélectionner un pays</option>
                    {options.map(opt => <option key={opt} value={opt} className="bg-slate-900">{opt}</option>)}
                </select>
            </div>
        );
        const SelectOp = ({ options, value, onChange, icon: Icon }) => (
            <div className="flex items-center gap-3 bg-slate-950 p-3 rounded-xl border border-slate-800 focus-within:border-blue-500 w-full">
                {Icon && <Icon size={18} className="text-slate-500" />}
                <select value={value} onChange={onChange} className="bg-transparent text-white w-full outline-none text-sm font-medium">
                    <option value="" disabled>Sélectionner un opérateur</option>
                    {options.map(opt => <option key={opt} value={opt} className="bg-slate-900">{opt}</option>)}
                </select>
            </div>
        );
        const Badge = ({ children, color = 'blue' }) => <span className={`px-2 py-0.5 rounded text-[10px] font-mono border uppercase tracking-wide bg-${color}-500/10 text-${color}-400 border-${color}-500/20`}>{children}</span>;

        // --- VUES ---
        const AuthView = ({ onLogin, onAdminLogin }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [formData, setFormData] = useState({ nom: '', prenom: '', pays: '', phone: '', password: '', referrerCode: '' });
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleAuth = async () => {
                setLoading(true); setError('');
                if (isLogin && formData.phone === ADMIN_PHONE && formData.password === ADMIN_PASS) return onAdminLogin();

                try {
                    if(!db) throw new Error("Serveur non connecté.");
                    const usersRef = db.collection(APP_COLLECTION).doc('data').collection('users');
                    if (isLogin) {
                        const snapshot = await usersRef.where('phone', '==', formData.phone).where('password', '==', formData.password).get();
                        if (snapshot.empty) throw new Error("Identifiants incorrects.");
                        const data = snapshot.docs[0].data();
                        if (data.isBlocked) throw new Error("Compte bloqué.");
                        onLogin({ ...data, id: snapshot.docs[0].id });
                    } else {
                        if (!formData.nom || !formData.phone || formData.password.length < 4 || (!isLogin && !formData.pays)) throw new Error("Remplissez tous les champs.");
                        const check = await usersRef.where('phone', '==', formData.phone).get();
                        if (!check.empty) throw new Error("Numéro déjà utilisé.");
                        
                        // --- GÉNÉRATION ID COURT ---
                        const customId = generateShortId(); // ID de 7 caractères
                        const myReferralCode = 'RZ' + Math.random().toString(36).substr(2, 6).toUpperCase();
                        
                        const newUser = {
                            firstName: formData.prenom, lastName: formData.nom, country: formData.pays,
                            phone: formData.phone, password: formData.password,
                            usdBalance: 3.74, btcBalance: 0, isVerified: false, isBlocked: false,
                            referralCode: myReferralCode, referredBy: formData.referrerCode || null,
                            activeReferrals: 0, totalReferralEarnings: 0, hasInvested: false,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        // SAUVEGARDE AVEC ID PERSONNALISÉ
                        await usersRef.doc(customId).set(newUser);
                        
                        onLogin({ ...newUser, id: customId });
                        alert("Bienvenue ! Bonus 3.74$ crédité.");
                    }
                } catch (err) {
                    setError(err.message + " (Vérifiez vos règles Firestore)");
                } finally { setLoading(false); }
            };

            return (
                <div className="min-h-screen w-full flex flex-col items-center justify-center px-6 relative overflow-hidden">
                    <div className="absolute top-[-10%] left-[-10%] w-64 h-64 bg-blue-600/20 rounded-full blur-[80px]"></div>
                    <div className="w-full max-w-sm z-10">
                        <div className="text-center mb-8"><div className="w-20 h-20 bg-gradient-to-tr from-blue-600 to-green-400 rounded-2xl mx-auto flex items-center justify-center shadow-2xl mb-4 logo-loading"><span className="text-4xl font-black text-slate-950">R</span></div><h1 className="text-3xl font-bold text-white">RAZERNING</h1><p className="text-green-400 text-xs mt-2 uppercase tracking-widest">Investir aujourd'hui, Récolter demain</p></div>
                        <Card>
                            <div className="flex mb-4 bg-slate-950 p-1 rounded-xl"><button onClick={() => setIsLogin(true)} className={`flex-1 py-2 text-xs font-bold rounded-lg ${isLogin ? 'bg-slate-800 text-white' : 'text-slate-500'}`}>CONNEXION</button><button onClick={() => setIsLogin(false)} className={`flex-1 py-2 text-xs font-bold rounded-lg ${!isLogin ? 'bg-slate-800 text-white' : 'text-slate-500'}`}>INSCRIPTION</button></div>
                            <div className="space-y-3">
                                {!isLogin && <><div className="flex gap-2"><Input placeholder="Nom" value={formData.nom} onChange={e=>setFormData({...formData,nom:e.target.value})}/><Input placeholder="Prénom" value={formData.prenom} onChange={e=>setFormData({...formData,prenom:e.target.value})}/></div><Select options={ALLOWED_COUNTRIES} value={formData.pays} onChange={e=>setFormData({...formData,pays:e.target.value})} icon={Globe} /></>}
                                <Input type="tel" placeholder="Numéro (ex: 07000000)" icon={Smartphone} value={formData.phone} onChange={e=>setFormData({...formData,phone:e.target.value})}/>
                                <Input type="password" placeholder="Mot de passe" icon={Lock} value={formData.password} onChange={e=>setFormData({...formData,password:e.target.value})}/>
                                {!isLogin && <Input placeholder="Code Parrain (Optionnel)" icon={Users} value={formData.referrerCode} onChange={e=>setFormData({...formData,referrerCode:e.target.value})}/>}
                                {error && <div className="text-red-400 text-xs text-center bg-red-500/10 p-2 rounded">{error}</div>}
                                <Button className="w-full mt-2" onClick={handleAuth} disabled={loading}>{loading ? "..." : (isLogin ? "Se Connecter" : "Créer Compte")}</Button>
                            </div>
                        </Card>
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPALE ---
        const UserApp = ({ user, onLogout, onUpdateUser }) => {
            const [tab, setTab] = useState('market');
            const [btcPrice, setBtcPrice] = useState(BASE_BTC_PRICE);
            const [serverOnline, setServerOnline] = useState(true);
            const [isTransferring, setIsTransferring] = useState(false);
            const [machines, setMachines] = useState([]);
            const [selectedOperator, setSelectedOperator] = useState('');

            // SYNC REALTIME USER
            useEffect(() => {
                if(!user.id || !db) return;
                const unsub = db.collection(APP_COLLECTION).doc('data').collection('users').doc(user.id).onSnapshot(doc => {
                    if(doc.exists) {
                        const data = doc.data();
                        if (data.usdBalance !== user.usdBalance || data.btcBalance !== user.btcBalance) {
                            onUpdateUser({ ...user, ...data });
                        }
                    }
                });
                
                // SYNC MACHINES (Correction Bug Disparition)
                const unsubMachines = db.collection(APP_COLLECTION).doc('data').collection('users').doc(user.id).collection('machines')
                    .onSnapshot(snapshot => {
                        const loadedMachines = snapshot.docs.map(doc => doc.data());
                        setMachines(loadedMachines);
                    });

                return () => { unsub(); unsubMachines(); };
            }, [user.id]);

            // PRICE & CRASH SIM
            useEffect(() => { const i = setInterval(() => setBtcPrice(p => p + (Math.random() - 0.5) * 100), 3000); return () => clearInterval(i); }, []);
            useEffect(() => { const i = setInterval(() => { if(Math.random() < 0.001) { setServerOnline(false); setTimeout(() => setServerOnline(true), Math.random()*10000+9000); } }, 15000); return () => clearInterval(i); }, []);

            // MINING LOOP (Local Calculation + Throttled Save)
            useEffect(() => {
                const i = setInterval(() => {
                    if (machines.length === 0 || !serverOnline) return;
                    let gen = 0;
                    machines.forEach(m => { const def = ALL_MACHINES.find(d => d.id === m.machineId); if(def) gen += ((def.price*(def.roiPercent/100))/(def.durationDays*24)/btcPrice)/3600; });
                    if (gen > 0) {
                        const newBtc = (user.btcBalance || 0) + gen;
                        onUpdateUser({ ...user, btcBalance: newBtc });
                        // Save every ~10s randomly to reduce writes
                        if(Math.random() < 0.1) db.collection(APP_COLLECTION).doc('data').collection('users').doc(user.id).update({ btcBalance: newBtc });
                    }
                }, 1000);
                return () => clearInterval(i);
            }, [machines, serverOnline, btcPrice]);

            // COMPANY BALANCE HELPER (INCREMENT/DECREMENT)
            const updateCompanyBalance = async (amount) => {
                if(!db) return;
                try {
                    const statsRef = db.collection(APP_COLLECTION).doc('stats').collection('global').doc('company');
                    await statsRef.set({ balance: firebase.firestore.FieldValue.increment(amount) }, { merge: true });
                } catch(e) {}
            };
            
            // HELPER FOR TOTAL FEES
            const updateCompanyFees = async (amount) => {
                if(!db) return;
                try {
                    const statsRef = db.collection(APP_COLLECTION).doc('stats').collection('global').doc('company');
                    await statsRef.set({ totalFees: firebase.firestore.FieldValue.increment(amount) }, { merge: true });
                } catch(e) {}
            };

            const handleBuy = async (m) => {
                if(!user.isVerified && m.price > 100) return alert("Vérification requise.");
                if (user.usdBalance >= m.price) {
                    const newBalance = user.usdBalance - m.price;
                    let updatedUser = { ...user, usdBalance: newBalance, hasInvested: true };
                    
                    // Update User Balance
                    await db.collection(APP_COLLECTION).doc('data').collection('users').doc(user.id).update({ usdBalance: newBalance, hasInvested: true });
                    
                    // SAVE MACHINE TO DB (Correction Bug Disparition)
                    await db.collection(APP_COLLECTION).doc('data').collection('users').doc(user.id).collection('machines').add({
                        machineId: m.id,
                        purchaseTime: Date.now(),
                        id: Date.now() // ID local simple pour les clés
                    });

                    updateCompanyBalance(m.price);

                    // Check referral
                    if (!user.hasInvested && user.referredBy) {
                        try {
                            const snapshot = await db.collection(APP_COLLECTION).doc('data').collection('users').where('referralCode', '==', user.referredBy).get();
                            if (!snapshot.empty) { await snapshot.docs[0].ref.update({ activeReferrals: firebase.firestore.FieldValue.increment(1) }); }
                        } catch(e) {}
                    }
                    
                    onUpdateUser(updatedUser);
                    alert("Machine activée !");
                } else alert("Solde insuffisant.");
            };

            const handleWithdraw = async () => {
                if (!selectedOperator) return alert("Veuillez choisir un opérateur.");
                const amountStr = prompt("Montant à retirer (USD):");
                if(!amountStr) return;
                const amount = parseFloat(amountStr);
                if(!amount || amount <= 0) return alert("Montant invalide");
                if(amount > user.usdBalance) return alert("Solde insuffisant");

                // Calculate Fee
                const feeRate = user.isVerified ? FEE_VERIFIED : FEE_UNVERIFIED;
                const feeAmount = amount * feeRate;
                const netAmount = amount - feeAmount; 

                // DEDUCTION
                await db.collection(APP_COLLECTION).doc('data').collection('users').doc(user.id).update({ usdBalance: user.usdBalance - amount });
                updateCompanyBalance(-netAmount); // Reduce company balance by amount paid out
                updateCompanyFees(feeAmount); // Add fee to company revenue

                onUpdateUser({ ...user, usdBalance: user.usdBalance - amount });
                
                window.open(`${PAYMENT_BOT_URL}?start=withdraw_${user.country}_${selectedOperator}_${amount}`, '_blank');
            };

            const handleDeposit = () => {
                if (!selectedOperator) return alert("Veuillez choisir un opérateur.");
                window.open(`${PAYMENT_BOT_URL}?start=deposit_${user.country}_${selectedOperator}`, '_blank');
            };

            const handleTransfer = () => {
                if (user.btcBalance <= 0.00000001) return alert("Solde trop faible.");
                setIsTransferring(true);
                setTimeout(async () => {
                    const val = user.btcBalance * btcPrice;
                    const newUsd = user.usdBalance + val;
                    await db.collection(APP_COLLECTION).doc('data').collection('users').doc(user.id).update({ btcBalance: 0, usdBalance: newUsd });
                    onUpdateUser({ ...user, btcBalance: 0, usdBalance: newUsd });
                    setIsTransferring(false);
                }, 10000);
            };

            return (
                <div className="min-h-screen w-full bg-slate-950 pb-safe relative flex flex-col">
                    {isTransferring && <div className="fixed inset-0 z-[100] bg-slate-950/95 flex flex-col items-center justify-center"><div className="relative w-32 h-32 flex items-center justify-center mb-8"><div className="absolute inset-0 border-4 border-green-600/30 rounded-full"></div><div className="absolute inset-0 border-4 border-green-500 border-t-transparent rounded-full spin-ring"></div><div className="text-6xl font-black text-white logo-loading">R</div></div><h2 className="text-2xl font-bold text-white">Transfert en cours...</h2></div>}
                    {!serverOnline && <div className="fixed top-0 w-full bg-red-600 text-white z-[60] text-[10px] font-bold text-center py-1 server-down-banner">⚠️ PERTE DE SIGNAL SERVEUR - RECONNEXION...</div>}

                    <header className="fixed top-0 w-full z-40 bg-slate-950/90 backdrop-blur-md border-b border-blue-900/20 px-4 h-16 flex justify-between items-center pt-2 box-border">
                        <div className="flex items-center gap-2"><div className="text-blue-500 font-black text-xl">R</div><span className="font-bold tracking-tight text-white">RAZERNING</span></div>
                        <div className="text-green-400 font-mono text-sm">${user.usdBalance?.toFixed(2)}</div>
                    </header>

                    <main className="flex-1 pt-20 px-4 pb-24 w-full max-w-md mx-auto box-border overflow-y-auto">
                        {tab === 'market' && <MarketPage usdBalance={user.usdBalance} onBuy={handleBuy} user={user} />}
                        {tab === 'dashboard' && <DashboardPage ownedMachines={machines} serverOnline={serverOnline} />}
                        {tab === 'wallet' && <WalletPage btcBalance={user.btcBalance||0} usdBalance={user.usdBalance||0} onTransferBTC={handleTransfer} onWithdraw={handleWithdraw} onDeposit={handleDeposit} user={user} currentBtcPrice={btcPrice} selectedOperator={selectedOperator} setSelectedOperator={setSelectedOperator} onLogout={onLogout} />}
                    </main>

                    <nav className="fixed bottom-0 w-full z-50 bg-slate-950 border-t border-slate-800 pb-safe h-16 flex justify-around items-center box-border"><button onClick={() => setTab('market')} className={`flex flex-col items-center ${tab==='market'?'text-blue-500':'text-slate-500'}`}><Server size={20}/><span className="text-[10px] font-bold">Market</span></button><button onClick={() => setTab('dashboard')} className={`flex flex-col items-center ${tab==='dashboard'?'text-blue-500':'text-slate-500'}`}><Activity size={20}/><span className="text-[10px] font-bold">Mining</span></button><button onClick={() => setTab('wallet')} className={`flex flex-col items-center ${tab==='wallet'?'text-blue-500':'text-slate-500'}`}><Wallet size={20}/><span className="text-[10px] font-bold">Wallet</span></button></nav>
                </div>
            );
        };

        // --- SOUS-COMPOSANTS DÉTAILLÉS ---
        const MarketPage = ({ usdBalance, onBuy, user }) => {
            const [filter, setFilter] = useState('all');
            const filtered = ALL_MACHINES.filter(m => filter === 'all' ? true : filter === 'month' ? m.durationDays === 30 : m.durationDays === 365);
            return (
                <div className="space-y-6 pb-28">
                    <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">{['all', 'month', 'year'].map(f => <button key={f} onClick={() => setFilter(f)} className={`px-4 py-2 rounded-lg text-xs font-bold uppercase transition-colors ${filter === f ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-400'}`}>{f === 'all' ? 'Tous' : f === 'month' ? '30 Jours' : '1 An'}</button>)}</div>
                    <div className="grid gap-4">{filtered.map(m => {
                        const isLocked = !user.isVerified && m.price > 100;
                        const canBuy = usdBalance >= m.price && !isLocked;
                        return (
                            <Card key={m.id} className={`relative group ${isLocked ? 'opacity-60' : ''}`}>
                                <div className="flex justify-between items-start mb-2"><div className="flex gap-3"><div className="bg-slate-800 p-2 rounded-lg"><Zap size={20} className="text-amber-500"/></div><div><h3 className="font-bold text-white text-sm">{m.name}</h3><div className="flex gap-1 mt-1"><Badge color="slate">{m.power} TH/s</Badge><Badge color="slate">{m.efficiency} J/TH</Badge></div></div></div><div className="text-lg font-bold text-white">${m.price}</div></div>
                                <div className="grid grid-cols-2 gap-2 text-[10px] text-slate-400 my-3 bg-slate-950/50 p-2 rounded-lg"><div><span className="block text-slate-500">Durée</span><span className="text-white font-mono">{m.durationDays} Jours</span></div><div className="text-right"><span className="block text-slate-500">ROI Est.</span><span className="text-green-400 font-mono font-bold">+{m.roiPercent}%</span></div></div>
                                {isLocked ? <Button variant="outline" disabled><Lock size={14}/> Vérification Requise</Button> : <Button onClick={() => onBuy(m)} disabled={!canBuy} variant={canBuy ? 'primary' : 'secondary'}>{canBuy ? 'Acheter' : 'Solde insuffisant'}</Button>}
                            </Card>
                        );
                    })}</div>
                </div>
            );
        };

        const DashboardPage = ({ ownedMachines, serverOnline }) => {
            const totalHash = ownedMachines.reduce((acc, m) => acc + (ALL_MACHINES.find(d => d.id === m.machineId)?.power || 0), 0);
            if (ownedMachines.length === 0) return <div className="flex flex-col items-center justify-center h-[60vh] text-center"><div className="bg-slate-800 p-6 rounded-full mb-4"><Server size={48} className="text-slate-500"/></div><h2 className="font-bold text-white">Aucun Mineur</h2><p className="text-slate-500 text-xs">Achetez une machine pour commencer.</p></div>;
            return (
                <div className="space-y-6 pb-28">
                    <Card className={`bg-slate-900 border-blue-900/30 relative overflow-hidden transition-colors ${!serverOnline?'border-red-500':''}`}>
                        <div className="flex justify-between items-start mb-4 relative z-10"><div><div className="flex items-center gap-2 mb-1">{serverOnline ? <div className="live-dot"></div> : <div className="w-2 h-2 rounded-full bg-red-500 animate-bounce"></div>}<span className={`text-[10px] uppercase font-bold ${serverOnline ? 'text-green-400' : 'text-red-500'}`}>{serverOnline ? 'Système en ligne' : 'CONNEXION PERDUE'}</span></div><div className="text-3xl font-mono font-bold text-white">{serverOnline ? totalHash : 0} <span className="text-sm text-slate-500 font-sans">TH/s</span></div></div></div>
                        <div className="bg-black/50 p-2 rounded font-mono text-[10px] space-y-1 h-16 overflow-hidden relative">
                            {serverOnline ? <><div className="text-green-500/80">[SYSTEM] Stratum connected.</div><div className="text-green-500/80">[WORKER] Job received.</div><div className="animate-pulse text-green-500">_</div></> : <><div className="text-red-500">[ERROR] Connection lost.</div><div className="text-red-500">[SYSTEM] Retrying...</div><div className="animate-pulse text-red-500">_</div></>}
                        </div>
                    </Card>
                    <div className="space-y-3">{ownedMachines.map(m => { const def = ALL_MACHINES.find(d=>d.id===m.machineId); return <Card key={m.id} className={`flex justify-between items-center ${!serverOnline?'opacity-50':''}`}><div className="flex gap-3 items-center"><div className="bg-slate-800 p-2 rounded"><Server size={16} className="text-blue-500"/></div><div><div className="font-bold text-white text-sm">{def.name}</div><div className="text-[10px] text-slate-500">{def.power} TH/s • {def.efficiency} J/TH</div></div></div><span className="text-xs text-slate-500">{serverOnline ? 'Actif' : 'Pause'}</span></Card>; })}</div>
                </div>
            );
        };

        const WalletPage = ({ btcBalance, usdBalance, onTransferBTC, user, currentBtcPrice, onWithdraw, onDeposit, selectedOperator, setSelectedOperator, onLogout }) => {
            const usdToFcfa = usdBalance * USD_TO_FCFA_RATE;
            const copyReferral = () => { navigator.clipboard.writeText(user.referralCode); alert("Code copié : " + user.referralCode); };
            const copyID = () => { navigator.clipboard.writeText(user.id); alert("ID copié !"); };
            const operators = COUNTRY_CONFIG[user.country] || [];

            return (
                <div className="space-y-6 pb-28">
                    <div className="flex items-center gap-4 py-2">
                        <div className="w-14 h-14 bg-slate-800 rounded-full flex items-center justify-center text-blue-500 font-bold text-xl relative">
                            {user.firstName.charAt(0)}
                            {user.isVerified && <div className="absolute -bottom-1 -right-1 bg-green-500 text-black rounded-full p-0.5"><CheckCircle size={12}/></div>}
                        </div>
                        <div>
                            <h2 className="font-bold text-white text-lg">{user.firstName} {user.lastName}</h2>
                            <div className="flex items-center gap-2 text-xs text-slate-400 bg-slate-900 px-2 py-1 rounded-lg border border-slate-800 mt-1">
                                <span>ID: {user.id}</span>
                                <button onClick={copyID} className="text-blue-400"><Copy size={12}/></button>
                            </div>
                            <div className="mt-1">{user.isVerified ? <Badge color="green">Vérifié</Badge> : <Badge color="red">Non Vérifié</Badge>}</div>
                        </div>
                    </div>
                    
                    <Card className="bg-gradient-to-br from-slate-900 to-slate-800 border-green-500/20 p-5 text-center"><div className="text-5xl font-bold text-white font-mono mb-2">${usdBalance.toFixed(2)}</div><div className="text-sm text-green-400 bg-green-500/10 px-4 py-1 rounded-full inline-block">≈ {Math.floor(user.usdBalance * USD_TO_FCFA_RATE).toLocaleString()} FCFA</div>
                    <div className="mt-4 text-left mb-2 text-xs text-slate-400">Moyen de paiement ({user.country}) :</div>
                    <SelectOp options={operators} value={selectedOperator} onChange={e => setSelectedOperator(e.target.value)} icon={Smartphone}/>
                    <div className="grid grid-cols-2 gap-4 mt-4"><button onClick={onDeposit} className="bg-green-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2"><ExternalLink size={18}/> DÉPÔT</button><button onClick={onWithdraw} className="bg-slate-700 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2"><ArrowRightLeft size={18}/> RETRAIT</button></div></Card>
                    
                    <Card className="bg-blue-900/10 border-blue-500/20 p-4"><div className="flex justify-between items-center mb-3"><h3 className="text-sm font-bold text-white flex items-center gap-2"><Users size={16} className="text-blue-400"/> Parrainage</h3><Badge color="blue">{user.activeReferrals || 0} Filleuls Actifs</Badge></div><div className="bg-slate-950 p-3 rounded-lg flex justify-between items-center border border-slate-800 mb-3"><div><div className="text-[10px] text-slate-500 uppercase">Mon Code</div><div className="font-mono font-bold text-white tracking-widest">{user.referralCode}</div></div><button onClick={copyReferral} className="p-2 bg-slate-800 rounded text-slate-300"><Copy size={16}/></button></div><div className="text-[10px] text-slate-400 mb-2">Gains Totaux: <span className="text-green-400 font-bold">${user.totalReferralEarnings?.toFixed(2) || "0.00"}</span> / 5.00$ Max</div><div className="w-full bg-slate-800 h-1.5 rounded-full overflow-hidden"><div className="bg-blue-500 h-full" style={{width: `${Math.min((user.activeReferrals || 0) * 2, 100)}%`}}></div></div></Card>

                    <Card className="bg-slate-900 border-amber-500/20 p-4"><div className="flex justify-between mb-3"><div><div className="text-[10px] text-slate-400 uppercase font-bold">Miné</div><div className="text-xl font-bold text-white font-mono">{btcBalance.toFixed(8)} BTC</div></div><Bitcoin size={24} className="text-amber-500"/></div><button onClick={onTransferBTC} className="w-full bg-amber-500 text-black py-3 rounded-lg font-bold flex items-center justify-center gap-2"><Repeat size={16}/> Transférer vers USD</button></Card>
                    <div className="space-y-2 pt-2 border-t border-slate-800"><Button variant="outline" className="w-full justify-between" onClick={() => window.open(SUPPORT_CHAT_URL, '_blank')}><div className="flex gap-3"><Headphones size={16}/> Support</div></Button><Button variant="danger" className="w-full justify-between" onClick={onLogout}><div className="flex gap-3"><LogOut size={16}/> Déconnexion</div></Button></div>
                </div>
            );
        };

        const AdminView = ({ onLogout }) => {
            const [users, setUsers] = useState([]);
            const [companyStats, setCompanyStats] = useState({ balance: 0, totalFees: 0 });

            useEffect(() => {
                if(db) {
                    // REAL TIME SNAPSHOT FOR USERS
                    db.collection(APP_COLLECTION).doc('data').collection('users').onSnapshot(snap => {
                        setUsers(snap.docs.map(d => ({id:d.id, ...d.data()})));
                    });
                    // REAL TIME SNAPSHOT FOR COMPANY STATS
                    db.collection(APP_COLLECTION).doc('stats').collection('global').doc('company').onSnapshot(doc => {
                        if(doc.exists) setCompanyStats(doc.data());
                    });
                }
            }, []);

            const totalUserBalance = users.reduce((acc, u) => acc + (u.usdBalance || 0), 0);
            const totalFees = companyStats.totalFees || 0;
            const companyBalance = companyStats.balance || 0;
            const companyFcfa = companyBalance * USD_TO_FCFA_RATE;

            const toggleBlock = async (uid, status) => { if(!confirm("Modifier le statut ?")) return; await db.collection(APP_COLLECTION).doc('data').collection('users').doc(uid).update({ isBlocked: !status }); };
            
            return (
                <div className="min-h-screen w-full bg-slate-950 p-4 pb-safe">
                    <div className="flex justify-between mb-6"><h1 className="text-xl font-bold text-white">ADMIN PANEL</h1><button onClick={onLogout}><LogOut className="text-red-500"/></button></div>
                    <Card className="bg-blue-900/20 mb-4 border-blue-500/30"><div className="text-xs text-slate-400 uppercase tracking-widest mb-1">Solde Entreprise (Net)</div><div className="text-3xl font-bold text-white font-mono">${companyBalance.toFixed(2)}</div><div className="text-sm text-blue-400">≈ {Math.floor(companyFcfa).toLocaleString()} FCFA</div></Card>
                    <div className="grid grid-cols-2 gap-3 mb-4"><Card className="bg-slate-900"><div className="text-[10px] text-slate-500 uppercase">Solde Utilisateurs</div><div className="text-lg font-bold text-white">${totalUserBalance.toFixed(2)}</div></Card><Card className="bg-slate-900"><div className="text-[10px] text-slate-500 uppercase">Frais Récoltés</div><div className="text-lg font-bold text-green-400">+${totalFees.toFixed(2)}</div></Card></div>
                    <h2 className="font-bold text-white mb-3 flex items-center gap-2"><Users size={18}/> Utilisateurs [{users.length}]</h2>
                    <div className="space-y-3 pb-10">{users.map(u => <Card key={u.id} className="p-3 flex flex-col gap-2 border-l-4 border-l-blue-600"><div className="flex justify-between items-start"><div><div className="font-bold text-white text-sm">{u.lastName} {u.firstName}</div><div className="text-xs text-slate-400">{u.country} • {u.phone}</div><div className="text-[10px] text-slate-500">ID: {u.id}</div></div><Badge color={u.isBlocked ? "red" : "green"}>{u.isBlocked ? "BLOQUÉ" : "ACTIF"}</Badge></div><div className="flex justify-between items-center bg-slate-950 p-2 rounded text-xs"><span>Solde: <span className="text-green-400 font-bold">${u.usdBalance?.toFixed(2)}</span></span><button onClick={() => toggleBlock(u.id, u.isBlocked)} className="text-slate-400 underline">{u.isBlocked ? "Débloquer" : "Bloquer"}</button></div></Card>)}</div>
                </div>
            );
        };

        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            useEffect(() => {
                const loader = document.getElementById('initial-loader');
                if(loader) loader.style.display = 'none';
                const s = localStorage.getItem('rz_user_v3'); 
                if(s) setCurrentUser(JSON.parse(s)); 
            }, []);
            const login = (u) => { const safe = {...u, createdAt:null}; setCurrentUser(safe); localStorage.setItem('rz_user_v3', JSON.stringify(safe)); setIsAdmin(false); };
            const logout = () => { setCurrentUser(null); localStorage.removeItem('rz_user_v3'); setIsAdmin(false); };
            if(isAdmin) return <AdminView onLogout={logout}/>;
            if(!currentUser) return <AuthView onLogin={login} onAdminLogin={() => setIsAdmin(true)}/>;
            if(currentUser.isBlocked) return <div className="min-h-screen w-full bg-slate-950 flex flex-col items-center justify-center p-6 text-center"><Lock size={48} className="text-red-500 mb-4"/><h1 className="text-2xl text-white font-bold">Compte Bloqué</h1><Button onClick={() => window.open(SUPPORT_CHAT_URL)}>Support</Button></div>;
            return <UserApp user={currentUser} onUpdateUser={login} onLogout={logout} />;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


